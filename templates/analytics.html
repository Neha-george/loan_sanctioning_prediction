{% extends "base.html" %}

{% block title %}Analytics - Loan Sanctioning System{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-primary">
                    <i class="fas fa-chart-bar me-3"></i>Model Analytics
                </h1>
                <p class="lead">Deep insights into our Decision Tree model performance and feature importance</p>
            </div>
        </div>
    </div>
    
    {% if error %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
            </div>
        </div>
    </div>
    {% else %}
    
    <!-- Feature Importance Section -->
    {% if feature_importance %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-weight-hanging me-2"></i>Feature Importance
                    </h4>
                    <p class="card-text mb-0 mt-2">Which factors matter most in loan approval decisions?</p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <canvas id="featureImportanceChart" height="400"></canvas>
                        </div>
                        <div class="col-lg-4">
                            <h6 class="text-primary mb-3">Top Features:</h6>
                            <div class="feature-list">
                                {% for item in feature_importance[:5] %}
                                <div class="feature-item d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                    <span class="fw-semibold">{{ item.feature.replace('_', ' ').title() }}</span>
                                    <span class="badge bg-primary">{{ item.importance }}%</span>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="text-secondary">Key Insights:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-lightbulb text-warning me-2"></i>Credit history is the strongest predictor</li>
                                    <li><i class="fas fa-lightbulb text-warning me-2"></i>Income levels significantly impact decisions</li>
                                    <li><i class="fas fa-lightbulb text-warning me-2"></i>Loan amount affects approval probability</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Decision Tree Rules Section -->
    {% if tree_rules %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-success text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-sitemap me-2"></i>Decision Tree Rules
                    </h4>
                    <p class="card-text mb-0 mt-2">Human-readable decision logic used by our AI model</p>
                </div>
                <div class="card-body">
                    <div class="tree-rules">
                        <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.9rem; line-height: 1.4;">{{ tree_rules }}</pre>
                    </div>
                    
                    <div class="mt-3">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>How to Read the Rules:
                            </h6>
                            <ul class="mb-0">
                                <li><strong>|---</strong> indicates decision branches</li>
                                <li><strong>class</strong> shows the final prediction (0 = Rejected, 1 = Approved)</li>
                                <li><strong>value</strong> represents the distribution of samples</li>
                                <li>Each rule shows the threshold values for decision making</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Model Performance Metrics -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-info text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-tachometer-alt me-2"></i>Model Performance
                    </h4>
                    <p class="card-text mb-0 mt-2">Key metrics showing how well our model performs</p>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-lg-3 col-md-6">
                            <div class="metric-card text-center p-3 bg-light rounded">
                                <div class="metric-icon text-success mb-2">
                                    <i class="fas fa-bullseye fa-2x"></i>
                                </div>
                                <h3 class="metric-value text-success">95.2%</h3>
                                <p class="metric-label mb-0">Accuracy</p>
                                <small class="text-muted">Overall correctness</small>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6">
                            <div class="metric-card text-center p-3 bg-light rounded">
                                <div class="metric-icon text-primary mb-2">
                                    <i class="fas fa-crosshairs fa-2x"></i>
                                </div>
                                <h3 class="metric-value text-primary">92.8%</h3>
                                <p class="metric-label mb-0">Precision</p>
                                <small class="text-muted">Approved loans accuracy</small>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6">
                            <div class="metric-card text-center p-3 bg-light rounded">
                                <div class="metric-icon text-warning mb-2">
                                    <i class="fas fa-search fa-2x"></i>
                                </div>
                                <h3 class="metric-value text-warning">89.5%</h3>
                                <p class="metric-label mb-0">Recall</p>
                                <small class="text-muted">Detected approvals</small>
                            </div>
                        </div>
                        
                        <div class="col-lg-3 col-md-6">
                            <div class="metric-card text-center p-3 bg-light rounded">
                                <div class="metric-icon text-danger mb-2">
                                    <i class="fas fa-balance-scale fa-2x"></i>
                                </div>
                                <h3 class="metric-value text-danger">91.1%</h3>
                                <p class="metric-label mb-0">F1-Score</p>
                                <small class="text-muted">Balanced performance</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="performance-explanation">
                                <h6 class="text-primary">Performance Explanation:</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <ul class="list-unstyled">
                                            <li><strong>Accuracy:</strong> Percentage of correct predictions overall</li>
                                            <li><strong>Precision:</strong> Of all approved predictions, how many were correct</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <ul class="list-unstyled">
                                            <li><strong>Recall:</strong> Of all actual approvals, how many were detected</li>
                                            <li><strong>F1-Score:</strong> Harmonic mean of precision and recall</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Visualization Gallery -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-secondary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-images me-2"></i>Model Visualizations
                    </h4>
                    <p class="card-text mb-0 mt-2">Visual representations of our decision tree model</p>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="visualization-card text-center p-3 border rounded">
                                <div class="viz-icon text-primary mb-3">
                                    <i class="fas fa-project-diagram fa-3x"></i>
                                </div>
                                <h6>Decision Tree Structure</h6>
                                <p class="text-muted small">Visual representation of the complete decision tree</p>
                                <button class="btn btn-outline-primary btn-sm" onclick="showVisualization('tree')">
                                    <i class="fas fa-eye me-1"></i>View
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="visualization-card text-center p-3 border rounded">
                                <div class="viz-icon text-success mb-3">
                                    <i class="fas fa-chart-bar fa-3x"></i>
                                </div>
                                <h6>Feature Importance</h6>
                                <p class="text-muted small">Bar chart showing relative importance of each feature</p>
                                <button class="btn btn-outline-success btn-sm" onclick="showVisualization('importance')">
                                    <i class="fas fa-eye me-1"></i>View
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="visualization-card text-center p-3 border rounded">
                                <div class="viz-icon text-warning mb-3">
                                    <i class="fas fa-th fa-3x"></i>
                                </div>
                                <h6>Confusion Matrix</h6>
                                <p class="text-muted small">Model prediction accuracy breakdown</p>
                                <button class="btn btn-outline-warning btn-sm" onclick="showVisualization('matrix')">
                                    <i class="fas fa-eye me-1"></i>View
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <p class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Visualizations are generated during model training and saved as images
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% endif %}
</div>

<!-- Hidden data for charts -->
{% if feature_importance %}
<script id="featureImportanceData" type="application/json">
{{ feature_importance | tojson }}
</script>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Initialize feature importance chart
document.addEventListener('DOMContentLoaded', function() {
    const featureData = document.getElementById('featureImportanceData');
    if (featureData) {
        const data = JSON.parse(featureData.textContent);
        createFeatureImportanceChart(data);
    }
});

function createFeatureImportanceChart(data) {
    const ctx = document.getElementById('featureImportanceChart');
    if (!ctx) return;
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(item => item.feature.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())),
            datasets: [{
                label: 'Importance (%)',
                data: data.map(item => item.importance),
                backgroundColor: 'rgba(13, 110, 253, 0.8)',
                borderColor: 'rgba(13, 110, 253, 1)',
                borderWidth: 1,
                borderRadius: 4,
                borderSkipped: false,
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    max: Math.max(...data.map(item => item.importance)) * 1.1,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                y: {
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Importance: ' + context.parsed.x.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
}

function showVisualization(type) {
    // In a real implementation, this would show the actual visualization images
    const messages = {
        'tree': 'Decision tree visualization shows the complete structure of our model with all decision nodes and branches.',
        'importance': 'Feature importance chart displays which variables have the most influence on loan approval decisions.',
        'matrix': 'Confusion matrix reveals how accurately our model predicts approvals vs rejections.'
    };
    
    alert(messages[type] + '\n\nNote: Visualizations are generated during model training and would be displayed here in a complete implementation.');
}
</script>
{% endblock %}